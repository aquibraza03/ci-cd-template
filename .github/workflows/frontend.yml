name: üåê Frontend CI/CD Enterprise (S3 + CloudFront)

on:
  push:
    branches: ["main"]
    paths:
      - 'app-examples/frontend/**'
  pull_request:
    branches: ["main"]
    paths:
      - 'app-examples/frontend/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  deployments: write

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'push' }}

env:
  AWS_REGION: ap-south-1
  NODE_VERSION: 20
  BUILD_DIR: app-examples/frontend/out

jobs:
  test:
    name: üß™ Tests & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "app-examples/frontend/package-lock.json"

      - name: Install, lint, test
        run: |
          cd app-examples/frontend
          npm ci --frozen-lockfile
          npm run lint
          npm test -- --coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: app-examples/frontend/coverage/

  build:
    name: üèóÔ∏è Build Static Site
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "app-examples/frontend/package-lock.json"

      - name: Build static export
        run: |
          cd app-examples/frontend
          npm ci --frozen-lockfile
          npm run build
          npx next export

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.BUILD_DIR }}

  deploy-preview:
    name: üîÑ Preview Deploy (PR)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    environment: preview

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: AWS OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to Preview S3 (cache optimized)
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_PREVIEW_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html"
          
          aws s3 sync dist/ s3://${{ secrets.S3_PREVIEW_BUCKET }}/ \
            --delete \
            --cache-control "no-cache" \
            --include "*.html"

      - name: Comment Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üñ•Ô∏è **Preview Live:** https://${{ secrets.S3_PREVIEW_BUCKET }}.s3.ap-south-1.amazonaws.com/`
            })

  deploy-production:
    name: üöÄ Production Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: AWS OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to Production S3 (cache optimized)
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_PROD_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html"

          aws s3 sync dist/ s3://${{ secrets.S3_PROD_BUCKET }}/ \
            --delete \
            --cache-control "no-cache" \
            --include "*.html"

      - name: CloudFront Invalidation
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION }} \
            --paths "/*"

      - name: Slack Success
        if: success()
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: success
          fields: repo,commit,author,workflow

  notify-failure:
    name: üö® Failure Alert
    runs-on: ubuntu-latest
    if: failure()
    needs: [test, build, deploy-preview, deploy-production]
    steps:
      - name: Slack Failure
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: failure
          fields: repo,commit,author,workflow

