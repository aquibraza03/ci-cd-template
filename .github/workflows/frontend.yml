name: ðŸŒ Frontend CI/CD Enterprise (AWS-Aligned)

on:
  push:
    branches: ["main"]
    paths:
      - "app-examples/frontend/**"
  pull_request:
    branches: ["main"]
    paths:
      - "app-examples/frontend/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  deployments: write

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'push' }}

env:
  NODE_VERSION: 20
  AWS_REGION: ap-south-1
  BUILD_DIR: dist
  FRONTEND_HEALTH_URL: https://app.example.com

# ================= DETECT FRAMEWORK =================
jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      build_dir: ${{ steps.meta.outputs.build_dir }}

    steps:
      - uses: actions/checkout@v4

      - id: meta
        run: |
          if [ -f "app-examples/frontend/next.config.js" ]; then
            echo "build_dir=app-examples/frontend/out" >> $GITHUB_OUTPUT
          elif [ -d "app-examples/frontend/dist" ]; then
            echo "build_dir=app-examples/frontend/dist" >> $GITHUB_OUTPUT
          elif [ -d "app-examples/frontend/build" ]; then
            echo "build_dir=app-examples/frontend/build" >> $GITHUB_OUTPUT
          else
            echo "build_dir=app-examples/frontend/dist" >> $GITHUB_OUTPUT
          fi

# ================= TEST =================
  test:
    runs-on: ubuntu-latest
    needs: detect

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: app-examples/frontend/package-lock.json

      - run: |
          cd app-examples/frontend
          npm ci
          npm run lint --if-present
          npm test --if-present -- --coverage || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: app-examples/frontend/coverage/

# ================= BUILD =================
  build:
    runs-on: ubuntu-latest
    needs: [detect, test]

    outputs:
      build_dir: ${{ needs.detect.outputs.build_dir }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: app-examples/frontend/package-lock.json

      - run: |
          cd app-examples/frontend
          npm ci
          npm run build
          if [ -f "next.config.js" ]; then
            npx next export
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ needs.detect.outputs.build_dir }}

# ================= PREVIEW (OPTIONAL SaaS) =================
  preview:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      # Optional Vercel preview
      - if: secrets.VERCEL_TOKEN != ''
        run: |
          npm i -g vercel
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --yes

      # Optional Netlify preview
      - if: secrets.NETLIFY_AUTH_TOKEN != ''
        run: |
          npm i -g netlify-cli
          netlify deploy --dir=dist --auth=${{ secrets.NETLIFY_AUTH_TOKEN }}

# ================= PRODUCTION (AWS PRIMARY) =================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ env.FRONTEND_HEALTH_URL }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      # Upload with correct caching
      - run: |
          aws s3 sync dist/ s3://${{ secrets.S3_PROD_BUCKET }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html"

          aws s3 sync dist/ s3://${{ secrets.S3_PROD_BUCKET }}/ \
            --delete \
            --cache-control "no-cache" \
            --include "*.html"

      # CloudFront invalidation
      - id: invalidate
        run: |
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION }} \
            --paths "/*" \
            --query 'Invalidation.Id' --output text)

          echo "id=$INVALIDATION_ID" >> $GITHUB_OUTPUT

      # Wait for invalidation completion
      - run: |
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION }} \
            --id ${{ steps.invalidate.outputs.id }}

      # Health check (enterprise parity with backend)
      - name: Verify frontend health
        run: |
          curl -f ${{ env.FRONTEND_HEALTH_URL }}

      # Slack success
      - if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: success
          fields: repo,commit,author,workflow

# ================= FAILURE ALERT =================
  notify-failure:
    runs-on: ubuntu-latest
    if: failure()
    needs: [detect, test, build, preview, deploy]

    steps:
      - if: secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: failure
          fields: repo,commit,author,workflow



